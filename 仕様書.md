# Choppy (音声ファイル分割ダウンロードアプリ) 要件定義書・仕様書

## 1. プロジェクト概要

### 1.1 目的

音声ファイル（MP3、M4A 等）をユーザーが指定したタイムスタンプに基づいて分割し、個別のファイルとして ZIP 形式でダウンロードできる Web アプリケーションを開発する。

### 1.2 特徴

- 完全クライアントサイド動作（サーバー不要）
- シンプルで直感的な UI
- 複数の音声形式に対応
- メタデータの保持

## 2. 機能要件

### 2.1 ファイルアップロード機能

- **対応形式**: MP3(最優先)、M4A、AAC、OGG、WAV
- **アップロード方法**:
  - ドラッグ&ドロップ
  - ファイル選択ボタン
- **制限事項**:
  - 最大ファイルサイズ: 500MB
  - 同時アップロード数: 1 ファイル

### 2.2 タイムスタンプ入力機能

- **入力方法**: テキストエリアへの一括入力
- **入力形式**:
  ```
  開始時間 ~ 終了時間 タイトル
  ```
- **時間形式**: `MM:SS` または `HH:MM:SS`
- **分割精度**: 秒単位
- **省略ルール**:
  - 開始時間省略時: 前のセグメントの終了時間を使用
  - 終了時間省略時: 次のセグメントの開始時間を使用
- **入力例**:
  ```
  00:00 ~ 03:00 - 最初
  ~ 04:00 - 二番目のファイル (この場合は開始時間省略。一行上の開始時間を使用)
  09:00 ~ 13:00 - 最後
  ```
- **バリデーション**:
  - 時間の重複チェック
  - ファイル長を超える時間の検出
  - 不正な時間形式の検出

### 2.3 音声分割処理機能

- **処理内容**:
  - 指定されたタイムスタンプに基づいて音声を分割（秒単位）
  - 各セグメントを個別のファイルとして生成
  - 元ファイルのメタデータを可能な限り保持
- **ファイル名規則**:
  - ユーザー指定のタイトル + 元の拡張子
  - 特殊文字の自動変換（ファイル名として使用不可な文字）
- **メタデータ保持**:
  - アーティスト名
  - アルバム名
  - 年
  - ジャンル
  - アルバムアート（可能な場合）
  - その他の基本的なメタデータ

### 2.4 ダウンロード機能

- **形式**: ZIP 圧縮
- **内容**: 分割された全ての音声ファイル
- **ファイル名**: `分割音声_YYYYMMDD_HHMMSS.zip`

### 2.5 プレビュー機能

- 分割前の音声再生
- タイムスタンプ位置のビジュアル表示
- 各セグメントの試聴機能
- メタデータの表示

## 3. 非機能要件

### 3.1 パフォーマンス

- ファイル読み込み: 100MB あたり 5 秒以内
- 分割処理: 10 分の音声を 5 セグメントに分割する場合、10 秒以内
- UI 応答: 100ms 以内

### 3.2 使いやすさ

- 直感的なインターフェース
- エラーメッセージの明確な表示
- 処理進捗の可視化
- テキストエリアでの一括編集

### 3.3 互換性

- ブラウザは Chrome を使用することを想定しています。

## 4. 技術仕様

### 4.1 使用技術

- **フレームワーク**: React 19
- **スタイリング**: Tailwind CSS
- **UI コンポーネント**: shadcn/ui
- **音声処理**: Web Audio API, AudioContext
- **メタデータ処理**: music-metadata-browser（MP3、M4A 等のメタデータ読み取り）
- **音声エンコード**: lamejs（MP3）、webm-muxer（その他形式）
- **ファイル処理**: File API, Blob API
- **ZIP 生成**: JSZip

### 4.2 アーキテクチャ

```
src/
├── components/
│   ├── FileUploader.tsx      # ファイルアップロードコンポーネント
│   ├── TimestampEditor.tsx   # タイムスタンプ一括編集コンポーネント
│   ├── AudioPlayer.tsx       # 音声プレビューコンポーネント
│   ├── MetadataDisplay.tsx   # メタデータ表示コンポーネント
│   ├── ProgressBar.tsx       # 進捗表示コンポーネント
│   └── DownloadButton.tsx    # ダウンロードボタンコンポーネント
├── hooks/
│   ├── useAudioProcessor.ts  # 音声処理カスタムフック
│   ├── useMetadata.ts        # メタデータ処理カスタムフック
│   └── useFileHandler.ts     # ファイル処理カスタムフック
├── utils/
│   ├── audioSplitter.ts      # 音声分割ロジック
│   ├── metadataHandler.ts    # メタデータ処理ロジック
│   ├── timestampParser.ts    # タイムスタンプパースロジック
│   ├── zipGenerator.ts       # ZIP生成ロジック
│   └── validators.ts         # バリデーションロジック
└── App.tsx                   # メインアプリケーションコンポーネント
```

### 4.3 データ構造

```typescript
interface Timestamp {
  id: string;
  startTime: number; // 秒単位
  endTime: number; // 秒単位
  title: string;
  isStartOmitted?: boolean;
  isEndOmitted?: boolean;
}

interface AudioMetadata {
  title?: string;
  artist?: string;
  album?: string;
  year?: string;
  genre?: string[];
  picture?: Picture[];
  [key: string]: any;
}

interface AudioSegment {
  blob: Blob;
  filename: string;
  duration: number;
  metadata: AudioMetadata;
}

interface AppState {
  file: File | null;
  originalMetadata: AudioMetadata | null;
  timestamps: Timestamp[];
  timestampText: string;
  segments: AudioSegment[];
  isProcessing: boolean;
  progress: number;
  error: string | null;
}
```

## 5. UI/UX 設計

### 5.1 レイアウト

- シングルページアプリケーション
- 上から下への自然な作業フロー
  1. ファイルアップロードエリア
  2. メタデータ表示エリア（ファイルアップロード後に表示）
  3. タイムスタンプ入力エリア（テキストエリア）
  4. プレビューエリア
  5. ダウンロードボタン

### 5.2 タイムスタンプ入力 UI

- 大きめのテキストエリア（最小 10 行）
- 等幅フォントでの表示
- リアルタイムバリデーション
- 構文ハイライト（可能であれば）
- 入力例の表示

### 5.3 インタラクション

- ドラッグ&ドロップ時のビジュアルフィードバック
- リアルタイムバリデーション表示
- 処理中のローディング表示
- 完了時の成功メッセージ

## 6. エラーハンドリング

### 6.1 想定エラー

- 非対応ファイル形式
- ファイルサイズ超過
- 不正なタイムスタンプ形式
- 時間範囲の重複
- ブラウザメモリ不足
- メタデータ読み取り失敗

### 6.2 エラー表示

- トースト通知での一時的なエラー表示
- テキストエリア下部でのバリデーションエラー表示
- 重大なエラー時のモーダル表示

## 7. 処理フロー

### 7.1 基本フロー

1. ユーザーが音声ファイルをアップロード
2. メタデータを読み取り、表示
3. ユーザーがテキストエリアにタイムスタンプを一括入力
4. リアルタイムでバリデーション実行
5. 「ダウンロード」ボタン押下で分割処理開始
6. 各セグメントにメタデータを付与しながら分割
7. ZIP ファイルを生成してダウンロード

### 7.2 メタデータ処理フロー

1. 元ファイルからメタデータを抽出
2. 各分割ファイルに基本メタデータをコピー
3. タイトルフィールドは「元のタイトル - セグメント名」形式に更新
4. トラック番号がある場合は連番で更新

## 8. 制限事項

### 8.1 メタデータ関連

- 一部の特殊なメタデータは保持できない可能性がある
- DRM 保護されたファイルは処理不可
- アルバムアートのサイズが大きい場合は圧縮される可能性がある

### 8.2 ブラウザ制限

- ブラウザのメモリ制限により、大きなファイルは処理できない場合がある
- 長時間の処理でタブがクラッシュする可能性がある

## 9. 今後の拡張可能性

- 動画ファイル対応
- バッチ処理（複数ファイル同時処理）
- クラウドストレージ連携
- フェード効果の追加
- 音声形式の変換機能
- より詳細なメタデータ編集機能
- タイムスタンプのインポート/エクスポート機能

```

メタデータの保持機能を追加し、タイムスタンプ入力は一括入力方式、分割精度は秒単位として仕様を更新しました。メタデータ処理にはmusic-metadata-browserライブラリを使用することで、MP3やM4Aなどの主要な形式のメタデータを適切に扱えるようにしています。
```
